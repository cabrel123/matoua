<template>
  <div class="page login-screen-page page-ride-payment">
    <div class="navbar">
      <div class="navbar-bg"></div>
      <div class="navbar-inner sliding">
        <div class="left">
          <a class="link back">
            <i class="icon icon-back"></i>
          </a>
        </div>
        <div class="title">Trouver un trajet</div>
      </div>
    </div>
    <div class="page-content">
      <div class="block block-strong-ios block-outline-ios">
        <h3 class="center">Finaliser votre réservation</h3>
        <div class="card">
          <div class="card-content">
            <div class="data-table">
              <table>
                <tbody>
                  <tr>
                    <td class="label-cell">Départ</td>
                    <td class="numeric-cell departure"></td>
                  </tr>
                  <tr>
                    <td class="label-cell">Destination</td>
                    <td class="numeric-cell destination"></td>
                  </tr>
                  <tr>
                    <td class="label-cell">Date de départ</td>
                    <td class="numeric-cell departureDate"></td>
                  </tr>
                  <tr>
                    <td class="label-cell">Nb. sièges disponibles</td>
                    <td class="numeric-cell numberofseat"></td>
                  </tr>
                  <tr>
                    <td class="label-cell">Lieu de départ</td>
                    <td class="numeric-cell departureLocation"></td>
                  </tr>
                  <tr>
                    <td class="label-cell">Lieu d'arrivée</td>
                    <td class="numeric-cell destinationLocation"></td>
                  </tr>
                  <tr>
                    <td class="label-cell">Modèle de voiture</td>
                    <td class="numeric-cell car"></td>
                  </tr>
                  <tr>
                    <td class="label-cell">Montant</td>
                    <td class="numeric-cell">
                      <span class="amount"></span> FCFA
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="block" id="login-block" style="display: none">
        <h3 class="center">
          Vous êtes à un clic de finaliser votre réservation, connectez-vous ou
          inscrivez-vous !
        </h3>
        <a
          class="button button-raised button-large button-fill color-black popup-open margin-bottom-half"
          data-popup=".login-popup-swipe-handler"
          >Se connecter</a
        >
        <a
          class="button button-raised button-large button-fill popup-open"
          data-popup=".register-popup-swipe-handler"
          >Créer un compte</a
        >
      </div>
      <div class="block" id="payment-block" style="display: none">
        <h3 class="center">
          Vous êtes à un clic de finaliser votre réservation !
        </h3>
        <form
          name="requestPayment"
          action="#"
          method="POST"
          id="requestPayment"
          enctype="multipart/form-data"
        >
          <p style="display: none">
            <input
              type="text"
              placeholder="Montant"
              name="amount"
              id="amount-1"
              value="4000"
            />
          </p>
          <h3 class="title">
            Finalisez votre réservation : <span class="amount"></span> FCFA
          </h3>
          <div class="block block-strong-ios block-outline-ios">
            <p>Choisissez le moyen de paiement</p>
            <p class="grid grid-cols-2 grid-gap">
              <a href="#tab-1" class="tab-link tab-link-active"
                ><img src="assets/img/om.png" alt="om" width="80" height="80"
              /></a>
              <a href="#tab-2" class="tab-link"
                ><img src="assets/img/momo.png" alt="om" width="80" height="80"
              /></a>
            </p>
            <div class="tabs">
              <div id="tab-1" class="page-content tab tab-active">
                <div class="list list-strong-ios list-dividers-ios inset-ios">
                  <ul>
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-input-wrap">
                          <input
                            type="text"
                            placeholder=" Votre compte Orange Money"
                            name="omphone"
                            id="omphone"
                            required
                            validate
                          />
                          <span class="input-clear-button"></span>
                        </div>
                      </div>
                    </li>
                  </ul>
                </div>
              </div>
              <div id="tab-2" class="page-content tab">
                <div class="list list-strong-ios list-dividers-ios inset-ios">
                  <ul>
                    <li class="item-content item-input">
                      <div class="item-inner">
                        <div class="item-input-wrap">
                          <input
                            type="text"
                            placeholder="Votre compte MTN Mobile Money"
                            name="momophone"
                            id="momophone"
                            required
                            validate
                          />
                          <span class="input-clear-button"></span>
                        </div>
                      </div>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
          <div class="content-block">
            <a
              class="button button-big button-block button-fill button-round color-black"
              @click="${requestPayment}"
              tkey="POST"
              >Valider</a
            >
          </div>
        </form>
      </div>
    </div>
    <div class="popup demo-popup-swipe-handler login-popup-swipe-handler">
      <div class="page">
        <div class="navbar">
          <div class="navbar-bg"></div>
          <div class="navbar-inner">
            <div class="title">Connexion</div>
            <div class="right"><a class="link popup-close">Fermer</a></div>
          </div>
        </div>
        <div class="swipe-handler"></div>
        <div class="page-content">
          <div class="block block-strong-ios block-outline-ios">
            <form>
              <div class="list">
                <ul>
                  <li class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">E-mail/Téléphone</div>
                      <div class="item-input-wrap">
                        <input
                          type="text"
                          placeholder="Votre adresse mail ou téléphone"
                          id="username-2"
                          name="email"
                          class="input-with-value"
                        />
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </li>
                  <li class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Mot de passe</div>
                      <div class="item-input-wrap">
                        <input
                          type="password"
                          placeholder="Votre mot de passe"
                          id="userpassword-2"
                          name="password"
                          class=""
                        />
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </li>
                </ul>
              </div>
              <div class="list inset">
                <ul>
                  <li>
                    <a class="list-button" @click="${signIn}">Connexion</a>
                  </li>
                </ul>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="popup demo-popup-swipe-handler register-popup-swipe-handler">
      <div class="page">
        <div class="navbar">
          <div class="navbar-bg"></div>
          <div class="navbar-inner">
            <div class="title">Inscription</div>
            <div class="right"><a class="link popup-close">Fermer</a></div>
          </div>
        </div>
        <div class="swipe-handler"></div>
        <div class="page-content">
          <div class="block block-strong-ios block-outline-ios">
            <form>
              <div class="list">
                <ul>
                  <li class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">
                        Nom(s) <span class="color-red">*</span>
                      </div>
                      <div class="item-input-wrap">
                        <input
                          type="text"
                          placeholder="Votre nom"
                          id="user-fullname-2"
                          class="input-with-value"
                        />
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </li>
                  <li class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">
                        Téléphone <span class="color-red">*</span>
                      </div>
                      <div class="item-input-wrap">
                        <input
                          type="text"
                          placeholder="Votre numéro de téléphone"
                          id="user-phone-2"
                          class="input-with-value"
                        />
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </li>

                  <li class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">
                        E-mail <span class="color-red">*</span>
                      </div>
                      <div class="item-input-wrap">
                        <input
                          type="email"
                          placeholder="Votre adresse mail"
                          id="user-email-2"
                          class="input-with-value"
                        />
                        <span class="input-clear-button"></span>
                      </div>
                    </div>
                  </li>
                  <li class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">
                        Mot de passe <span class="color-red">*</span>
                      </div>
                      <div class="item-input-wrap">
                        <input
                          type="password"
                          placeholder="Votre mot de passe"
                          id="user-password-3"
                          class=""
                        />
                      </div>
                    </div>
                  </li>
                  <li class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">
                        Téléchargez votre CNI
                        <span class="color-gray">(optionnel)</span>
                      </div>
                      <div class="item-input-wrap">
                        <input
                          type="file"
                          placeholder="Téléchargez votre CNI"
                          id="idcard-2"
                          accept="image/*"
                          capture="camera"
                          class=""
                        />
                      </div>
                    </div>
                  </li>
                </ul>
              </div>
              <div class="list inset">
                <ul>
                  <li>
                    <a class="list-button" @click="${signUp}">S'inscrire</a>
                  </li>
                </ul>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>
<style>
  .img-responsive {
    margin: 0 auto;
    display: block;
    max-width: 200px;
  }

  .page-ride-payment .page-content {
    overflow-y: auto;
  }

  .login-screen-page .navbar-inner .title,
  .login-screen-page .navbar-inner .link .icon,
  .login-screen-page .title {
    color: #fff;
  }
  .color-red {
    color: #c0000a;
  }
  .color-gray {
    color: #dbe2f9;
  }
</style>
<script>
  export default (
    props,
    { $, $f7, $f7router, $on, $onMounted, $onBeforeUnmount }
  ) => {
    let popupSwipeHandler;

    $onMounted(() => {
      popupSwipeHandler = $f7.popup.create({
        el: ".demo-popup-swipe-handler",
        swipeToClose: "to-bottom",
        swipeHandler: ".swipe-handler",
      });
    });

    $on("pageInit", () => {
      const bookrideId = props.bookrideId;

      getBookrideDetail(bookrideId);
      const userId = localStorage.getItem("userId");

      if (userId == "" || userId == null || userId == "undefined") {
        $("#login-block").show();
        $("#payment-block").hide();
      } else {
        $("#login-block").hide();
        $("#payment-block").show();
      }
    });

    const signIn = () => {
      $f7.dialog.preloader("Un instant svp...");
      let email = $("#username-2").val();
      let password = $("#userpassword-2").val();

      if (email == "" || password == "") {
        $f7.dialog.close();
        app.dialog.alert("Veuillez renseigner tous les champs SVP !");
      } else {
        // API endpoint for creating a new user
        const apiUrl = "https://matoua.com/api/login";

        // Form data to be sent in the request body
        const formData = {
          email: email,
          password: password,
        };

        // Make a POST request using the Fetch API
        fetch(apiUrl, {
          method: "POST",
          mode: "cors",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(formData),
        })
          .then((response) => {
            if (!response.ok) {
              if (response.status == 401) {
                app.dialog.alert(
                  "Ooups! E-mail ou mot de passe incorrect ressayez svp !"
                );
              } else {
                throw new Error("Network response was not ok");
              }
            }
            return response.json();
          })
          .then((newUserData) => {
            // Process the newly created user data
            $f7.dialog.close();
            $f7.popup.close();

            localStorage.setItem("userId", newUserData.user.id);
            localStorage.setItem("fullname", newUserData.user.fullname);
            localStorage.setItem("phone", newUserData.user.phone);
            localStorage.setItem("email", newUserData.user.email);
            localStorage.setItem("token", newUserData.accessToken);

            $("#login-block").hide();
            $("#payment-block").show();
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }
    };

    const signUp = () => {
      $f7.dialog.preloader("Un instant svp...");
      let fullname = $("#user-fullname-2").val();
      let email = $("#user-email-2").val();
      let phone = $("#user-phone-2").val();
      let password = $("#user-password-3").val();

      if (fullname == "" || password == "" || phone == "" || email == "") {
        $f7.dialog.close();
        app.dialog.alert(
          "Veuillez renseigner tous les champs avec une étoile en rouge SVP !"
        );
      } else {
        const image = document.getElementById("idcard-2");
        if (image.files.length > 0) {
          const file = image.files[0];
          const formData = new FormData();

          formData.append("image", file);

          fetch("https://matoua.com/api/upload", {
            method: "POST",
            body: formData,
          })
            .then((response) => response.json())
            .then((data) => {
              console.log("Image uploaded successfully:", data);
              // API endpoint for creating a new user
              const apiUrl = "https://matoua.com/api/register";

              // Form data to be sent in the request body
              const formData = {
                fullname: fullname,
                email: email,
                phone: phone,
                password: password,
                password_confirmation: password,
                cni: data.url,
              };

              // Make a POST request using the Fetch API
              fetch(apiUrl, {
                method: "POST",
                mode: "cors",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(formData),
              })
                .then((response) => {
                  if (!response.ok) {
                    throw new Error("Network response was not ok");
                    app.dialog.alert(
                      "Ooups! Une erreur s'est produite ressayez svp !"
                    );
                  }
                  return response.json();
                })
                .then((newUserData) => {
                  $f7.dialog.close();
                  $f7.popup.close();
                  // Process the newly created user data
                  localStorage.setItem("userId", newUserData.user.id);
                  localStorage.setItem("fullname", newUserData.user.fullname);
                  localStorage.setItem("phone", newUserData.user.phone);
                  localStorage.setItem("email", newUserData.user.email);
                  localStorage.setItem("token", newUserData.accessToken);

                  $("#login-block").hide();
                  $("#payment-block").show();
                })
                .catch((error) => {
                  console.error("Error:", error);
                });
              // Handle the response as needed
            })
            .catch((error) => {
              console.error("Error uploading image:", error);
              // Handle the error as needed
            });
        } else {
          console.error("No file selected.");
          // API endpoint for creating a new user
          const apiUrl = "https://matoua.com/api/register";

          // Form data to be sent in the request body
          const formData = {
            fullname: fullname,
            email: email,
            phone: phone,
            password: password,
            password_confirmation: password,
            cni: "",
          };

          // Make a POST request using the Fetch API
          fetch(apiUrl, {
            method: "POST",
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(formData),
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error("Network response was not ok");
                app.dialog.alert(
                  "Ooups! Une erreur s'est produite ressayez svp !"
                );
              }
              return response.json();
            })
            .then((newUserData) => {
              $f7.dialog.close();
              $f7.popup.close();
              // Process the newly created user data
              localStorage.setItem("userId", newUserData.user.id);
              localStorage.setItem("fullname", newUserData.user.fullname);
              localStorage.setItem("phone", newUserData.user.phone);
              localStorage.setItem("email", newUserData.user.email);
              localStorage.setItem("token", newUserData.accessToken);

              $("#login-block").hide();
              $("#payment-block").show();
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        }
      }
    };

    const getBookrideDetail = (bookrideId) => {
      const numberofSeats = localStorage.getItem("numberofSeats");
      // API endpoint for creating a new user
      const apiUrl2 = "https://matoua.com/api/detail/" + bookrideId;

      // Make a POST request using the Fetch API
      fetch(apiUrl2)
        .then((response) => {
          if (!response.ok) {
            throw new Error("Network response was not ok");
            app.dialog.alert("Ooups! Une erreur s'est produite ressayez svp !");
          }
          return response.json();
        })
        .then((data) => {
          // Process the newly created user data
          //console.log("New Data:", data);

          $(".departure").html(data[0]["departureName"]);
          $(".destination").html(data[0]["destinationName"]);
          $(".departureDate").html(data[0]["departureDate"]);
          $(".numberofseat").html(data[0]["passenger"]);
          $(".departureLocation").html(data[0]["departureLocation"]);
          $(".destinationLocation").html(data[0]["destinationLocation"]);
          $(".car").html(data[0]["car"]);
          $(".amount").html(data[0]["amount"] * numberofSeats);
          $("#amount-1").val(data[0]["amount"] * numberofSeats);

          // check if number of seat request is greatest than passenger authorize by driver
          if (numberofSeats > data[0]["passenger"]) {
            app.dialog.alert(
              "Attention! Le nombre de siège que vous demandez est supérieur au nombre de place offert par le chauffeur !"
            );
          }
        })
        .catch((error) => {
          console.error("Error:", error);
        });
    };

    const requestPayment = () => {
      let amount = $("input#amount-1").val();
      let omphone = $("input#omphone").val();
      let momophone = $("input#momophone").val();
      if (
        amount == null ||
        amount == "" ||
        amount == 0 ||
        amount == "undefined"
      ) {
        $f7.dialog.alert("Le montant est incorrect");
      } else {
        const bookrideId = props.bookrideId;
        const userId = localStorage.getItem("userId");
        const numberofSeats = localStorage.getItem("numberofSeats");

        // API endpoint for creating a new user
        const apiUrl3 = "https://matoua.com/api/booking";

        // Form data to be sent in the request body
        const formData = {
          bookrideId: bookrideId,
          passenger: userId,
          numberofSeats: numberofSeats,
          status: 2,
        };

        // Make a POST request using the Fetch API
        fetch(apiUrl3, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(formData),
        })
          .then((response) => {
            if (!response.ok) {
              if (response.status == 401) {
                app.dialog.alert(
                  "Cette réservation existe déjà ! Veuillez essayer à nouveau SVP !"
                );
              } else {
                throw new Error("Network response was not ok");
                app.dialog.alert(
                  "Ooups! Une erreur s'est produite ressayez svp !"
                );
              }
            }
            return response.json();
          })
          .then((data) => {
            // Process the newly created user data
            //console.log("New Data:", data);
            localStorage.removeItem("departure");
            localStorage.removeItem("numberofSeats");
            localStorage.removeItem("destination");
            localStorage.removeItem("departureDate");

            $f7.dialog.alert(
              "Votre paiement de " + amount + " FCFA a bien été effectué !",
              function () {
                $f7.popup.close();
                var mainView = app.view.main;
                mainView.router.navigate("/ride-history/");
              }
            );
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }
    };

    $onBeforeUnmount(() => {
      // Destroy popup when page removed
      if (popupSwipeHandler) popupSwipeHandler.destroy();
    });

    return $render;
  };
</script>
